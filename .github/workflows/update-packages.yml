name: ğŸ”ƒ Package Update

on:
  schedule:
    - cron: '30 18 * * *'
  workflow_dispatch:
    inputs:
      parameters:
        description: 'Parameters for updater'
        required: false

jobs:
  update-choco-packages:
    runs-on: windows-2019
    steps:
      - name: ğŸ“š Checkout
        uses: actions/checkout@v2.3.4
      - name: ğŸ› ï¸ Install & Import AU
        shell: powershell
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module au
          Import-Module au
      - name: ğŸ« Set Chocolatey api key
        run: |
          choco apikey --key ${{ secrets.CHOCO_API_KEY }} --source https://push.chocolatey.org/
      - name: ğŸ”§ Run update script
        shell: powershell
        run: |
          $Env:au_Push = true
          $Env:github_api_key = ${{ secrets.GH_PAT }} 
          .\update_all.ps1 ${{ github.event.inputs.parameters }}
  update-aur-packages:
    runs-on: ubuntu-latest
    outputs:
      updatedPackages: ${{ steps.updatePKGs.outputs.updatedPackages }}
    steps:
      - name: ğŸ“š Checkout
        uses: actions/checkout@v2.3.4
      - name: ğŸ”§ Run update script
        id: updatePKGs
        run: |
          bash update-pkg.sh ${{ github.event.inputs.aur-package }}
      - name: ğŸ“Œ Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'feat: ğŸ”¼ Update AUR packages (${{ steps.updatePKGs.outputs.updatedPackages }})'
  publish-aur-packages:
    name: ğŸš€ Publish updated packages
    needs: update-aur-packages
    uses: kamack38/packages/.github/workflows/_CD-AUR.yml@main
    with:
      packages: ${{ needs.update-aur-packages.outputs.updatedPackages }}
