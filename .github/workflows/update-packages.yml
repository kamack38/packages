name: 🔃 Package Update

on:
  schedule:
    - cron: '30 18 * * *'
  workflow_dispatch:
    inputs:
      parameters:
        description: 'Parameters for updater'
        required: false

jobs:
  # update-choco-packages:
  #   runs-on: windows-latest
  #   steps:
  #     - name: 📚 Checkout
  #       uses: actions/checkout@v2.3.4
  #     - name: 🛠️ Install & Import AU
  #       shell: powershell
  #       run: |
  #         Set-PSRepository PSGallery -InstallationPolicy Trusted
  #         Install-Module au
  #         Import-Module au
  #     - name: 🍫 Set Chocolatey api key
  #       run: |
  #         choco apikey --key ${{ secrets.CHOCO_API_KEY }} --source https://push.chocolatey.org/
  #     - name: 🔧 Run update script
  #       shell: powershell
  #       run: |
  #         $Env:au_Push = $true
  #         $Env:github_api_key = "${{ secrets.GH_PAT }}"
  #         .\update_all.ps1 ${{ github.event.inputs.parameters }}
  # update-aur-packages:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     updatedPackages: ${{ steps.updatePKGs.outputs.updatedPackages }}
  #   steps:
  #     - name: 📚 Checkout
  #       uses: actions/checkout@v2.3.4
  #     - name: 🔧 Run update script
  #       id: updatePKGs
  #       run: |
  #         bash update-pkg.sh
  #     - name: 📌 Commit changes
  #       uses: stefanzweifel/git-auto-commit-action@v4
  #       with:
  #         commit_message: 'feat: 🔼 Update AUR packages (${{ steps.updatePKGs.outputs.updatedPackages }})'

  get-aur-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 🧬 Generate matrix
        id: gen-matrix
        run: |
          echo $(find ./packages/ -type f -name '*PKGBUILD' | sed -r 's|/[^/]+$||' | sort | uniq | cut -f3 -d'/' | jq -R | jq -cs)
          echo "::set-output name=packages::$(find ./packages/ -type f -name '*PKGBUILD' | sed -r 's|/[^/]+$||' | sort | uniq | cut -f3 -d'/' | jq -R | jq -cs)"
    outputs:
      packages: ${{ steps.gen-matrix.outputs.packages }}

  update-aur-packages:
    name: 🚀 Publish updated packages
    uses: kamack38/packages/.github/workflows/_CD-AUR.yml@main
    with:
      packages: ${{ needs.get-aur-packages.outputs.packages }}
    secrets:
      AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
      KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
      AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
      AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
